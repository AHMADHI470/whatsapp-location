<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Ø®Ø¯Ù…Ø© ØªÙˆØµÙŠÙ„ Ù…ØªØ¬Ø± Ø¬ÙˆÙ„ÙŠ ÙƒÙŠÙƒ</title>

  <style>
    body {
      font-family: system-ui, sans-serif;
      padding: 16px;
      background: #f7f7f7;
    }
    .card {
      max-width: 520px;
      margin: auto;
      background: #fff;
      padding: 16px;
      border-radius: 12px;
      box-shadow: 0 6px 20px rgba(0, 0, 0, 0.08);
    }
    h2 {
      text-align: center;
      margin-bottom: 10px;
    }
    label {
      display: block;
      margin: 10px 0 6px;
      font-weight: 600;
    }
    input,
    textarea {
      width: 100%;
      padding: 10px;
      border: 1px solid #ddd;
      border-radius: 8px;
      font-size: 15px;
    }
    textarea {
      resize: vertical;
      min-height: 60px;
    }
    button {
      width: 100%;
      padding: 12px;
      margin-top: 14px;
      background: #0088cc;
      color: #fff;
      border: none;
      border-radius: 10px;
      font-size: 16px;
      cursor: pointer;
    }
    .status {
      margin-top: 10px;
      font-size: 14px;
      color: #333;
      white-space: pre-line;
      min-height: 32px;
    }
    #map {
      height: 300px;
      border-radius: 10px;
      margin-top: 10px;
      display: none;
    }
  </style>

  <!-- Leaflet (Ø®Ø±ÙŠØ·Ø© Ù…Ø¬Ø§Ù†ÙŠØ©) -->
  <link
    rel="stylesheet"
    href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
  />
</head>

<body>
  <div class="card">
    <h2>Ø®Ø¯Ù…Ø© ØªÙˆØµÙŠÙ„ Ù…ØªØ¬Ø± Ø¬ÙˆÙ„ÙŠ ÙƒÙŠÙƒ</h2>

    <label>Ø§Ø³Ù…Ùƒ</label>
    <input id="name" placeholder="Ù…Ø«Ø§Ù„: Ø¢ÙŠØ© Ù…Ø­Ù…Ø¯" autocomplete="off" />

    <label>Ø±Ù‚Ù… Ù‡Ø§ØªÙÙƒ</label>
    <input id="phone" placeholder="Ù…Ø«Ø§Ù„: 093XXXXXXX" autocomplete="off" />

    <label>Ù…Ù„Ø§Ø­Ø¸Ø§Øª Ø¥Ø¶Ø§ÙÙŠØ©</label>
    <textarea id="notes" placeholder="Ø§ÙƒØªØ¨ Ù…Ù„Ø§Ø­Ø¸ØªÙƒ Ù‡Ù†Ø§"></textarea>

    <button id="showMapBtn">ğŸ“ Ø­Ø¯Ø¯ Ù…ÙˆÙ‚Ø¹ Ø§Ù„ØªÙˆØµÙŠÙ„ Ø¹Ù„Ù‰ Ø§Ù„Ø®Ø±ÙŠØ·Ø©</button>
    <div id="map"></div>

    <button id="sendBtn">Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø·Ù„Ø¨</button>

    <div class="status" id="status"></div>
  </div>

  <!-- ØµÙˆØª Ù†Ø¬Ø§Ø­ -->
  <audio id="successSound">
    <source src="https://actions.google.com/sounds/v1/cartoon/wood_plank_flicks.ogg" type="audio/ogg" />
    <source src="https://actions.google.com/sounds/v1/cartoon/wood_plank_flicks.mp3" type="audio/mpeg" />
  </audio>

  <!-- Leaflet JS -->
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

  <script>
    const token = "8448514696:AAGzvoVb0Rgqd8cY9Y_WfKj_7xDMTa3CT-M";
    const chatIds = ["939054281", "6748885574"];

    const status = document.getElementById("status");
    const successSound = document.getElementById("successSound");
    const mapDiv = document.getElementById("map");

    let map = null;
    let marker = null;
    let selectedLat = null;
    let selectedLon = null;

    // Ù…Ù†Ø¹ Ø§Ù„Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ù…ØªÙƒØ±Ø±
    function getDataHash(data) {
      return btoa(unescape(encodeURIComponent(JSON.stringify(data))));
    }

    function sendToTelegram(text) {
      return Promise.all(
        chatIds.map(id =>
          fetch(`https://api.telegram.org/bot${token}/sendMessage`, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({
              chat_id: id,
              text,
              parse_mode: "HTML"
            })
          })
        )
      );
    }

    // Ø²Ø± Ø¥Ø¸Ù‡Ø§Ø± Ø§Ù„Ø®Ø±ÙŠØ·Ø©
    document.getElementById("showMapBtn").addEventListener("click", () => {
      mapDiv.style.display = "block";

      if (!map) {
        map = L.map("map").setView([35.1318, 36.7532], 12); // Ø­Ù…Ø§Ø©

        L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
          maxZoom: 18
        }).addTo(map);

        map.on("click", e => {
          selectedLat = e.latlng.lat.toFixed(6);
          selectedLon = e.latlng.lng.toFixed(6);

          if (marker) {
            marker.setLatLng(e.latlng);
          } else {
            marker = L.marker(e.latlng).addTo(map);
          }

          status.textContent = "ğŸ“ ØªÙ… ØªØ­Ø¯ÙŠØ¯ Ù…ÙˆÙ‚Ø¹ Ø§Ù„ØªÙˆØµÙŠÙ„ Ø¨Ù†Ø¬Ø§Ø­";
        });
      } else {
        map.invalidateSize();
      }
    });

    // Ø²Ø± Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø·Ù„Ø¨
    document.getElementById("sendBtn").addEventListener("click", () => {
      const name = document.getElementById("name").value.trim();
      const phone = document.getElementById("phone").value.trim();
      const notes = document.getElementById("notes").value.trim();

      if (!name || !phone) {
        status.textContent = "âš ï¸ ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ Ø§Ù„Ø§Ø³Ù… ÙˆØ±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ";
        return;
      }

      if (!selectedLat || !selectedLon) {
        status.textContent = "âš ï¸ ÙŠØ±Ø¬Ù‰ ØªØ­Ø¯ÙŠØ¯ Ù…ÙˆÙ‚Ø¹ Ø§Ù„ØªÙˆØµÙŠÙ„ Ù…Ù† Ø§Ù„Ø®Ø±ÙŠØ·Ø©";
        return;
      }

      const data = { name, phone, notes, selectedLat, selectedLon };
      const newHash = getDataHash(data);
      const lastHash = localStorage.getItem("lastOrderHash");

      if (newHash === lastHash) {
        alert("âš ï¸ Ù‡Ø°Ø§ Ø§Ù„Ø·Ù„Ø¨ ØªÙ… Ø¥Ø±Ø³Ø§Ù„Ù‡ Ù…Ø³Ø¨Ù‚Ù‹Ø§ØŒ ÙŠØ±Ø¬Ù‰ ØªØºÙŠÙŠØ± Ø£ÙŠ Ù…Ø¹Ù„ÙˆÙ…Ø© Ø«Ù… Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„Ø¥Ø±Ø³Ø§Ù„");
        return;
      }

      const mapLink = `https://maps.google.com/?q=${selectedLat},${selectedLon}`;

      const text =
        `ğŸ“¦ <b>Ø·Ù„Ø¨ Ø¬Ø¯ÙŠØ¯ - Ù…ØªØ¬Ø± Ø¬ÙˆÙ„ÙŠ ÙƒÙŠÙƒ</b>\n\n` +
        `ğŸ‘¤ <b>Ø§Ù„Ø§Ø³Ù…:</b> ${name}\n` +
        `ğŸ“ <b>Ø§Ù„Ù‡Ø§ØªÙ:</b> ${phone}\n` +
        `ğŸ“ <b>Ù…Ù„Ø§Ø­Ø¸Ø§Øª:</b> ${notes || "Ù„Ø§ ØªÙˆØ¬Ø¯"}\n\n` +
        `ğŸ“ <b>Ù…ÙˆÙ‚Ø¹ Ø§Ù„ØªÙˆØµÙŠÙ„:</b>\n` +
        `<a href="${mapLink}">Ø§Ø¶ØºØ· Ù‡Ù†Ø§ Ù„ÙØªØ­ Ø§Ù„Ù…ÙˆÙ‚Ø¹ Ø¹Ù„Ù‰ Ø§Ù„Ø®Ø±ÙŠØ·Ø©</a>`;

      sendToTelegram(text)
        .then(() => {
          localStorage.setItem("lastOrderHash", newHash);

          status.innerHTML =
            "<span style='color:green;font-weight:bold;'>âœ… ØªÙ… Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø·Ù„Ø¨ Ø¨Ù†Ø¬Ø§Ø­</span>";

          successSound.play();

          const confirmMsg = encodeURIComponent(
            "âœ… ØªÙ… Ø§Ø³ØªÙ„Ø§Ù… Ø·Ù„Ø¨Ùƒ Ø¨Ù†Ø¬Ø§Ø­ Ù…Ù† Ù…ØªØ¬Ø± Ø¬ÙˆÙ„ÙŠ ÙƒÙŠÙƒ"
          );
          window.open(`https://wa.me/${phone}?text=${confirmMsg}`, "_blank");
        })
        .catch(() => {
          status.textContent = "âŒ Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„Ø¥Ø±Ø³Ø§Ù„";
        });
    });
  </script>
</body>
</html>
