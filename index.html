<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Ø®Ø¯Ù…Ø© ØªÙˆØµÙŠÙ„ Ù…ØªØ¬Ø± Ø¬ÙˆÙ„ÙŠ ÙƒÙŠÙƒ</title>
  <style>
    body { font-family: system-ui, sans-serif; padding: 16px; background:#f7f7f7; }
    .card { max-width: 520px; margin: auto; background:#fff; padding:16px; border-radius:12px; box-shadow:0 6px 20px rgba(0,0,0,.08); }
    h2 { text-align: center; margin-bottom: 8px; }
    p.welcome { text-align: center; font-weight: 600; margin-bottom: 20px; color: #444; }
    label { display:block; margin:10px 0 6px; font-weight:600; }
    input, textarea, select, button { width:100%; padding:10px; border:1px solid #ddd; border-radius:8px; font-size: 16px; }
    textarea { resize: vertical; min-height:60px; }
    button { cursor:pointer; color:#fff; border:none; margin-top:14px; border-radius:10px; }
    #locBtn { background:#0088cc; }
    #mapBtn { background:#673ab7; }
    #sendFromMapBtn { background:#28a745; margin-top:8px; display:none; }
    #cancelMapBtn { background:#d33; margin-top:8px; display:none; }
    .status { margin-top:10px; font-size:14px; color:#333; white-space: pre-line; min-height: 36px; }
    #map { height: 300px; border-radius: 12px; margin-top: 10px; display: none; }
  </style>

  <!-- Leaflet CSS -->
  <link
    rel="stylesheet"
    href="https://unpkg.com/leaflet@1.9.3/dist/leaflet.css"
    integrity="sha256-sA+e7XbAwssvy08/mtmP64PLmOLwFJYo0xSt59v+0uY="
    crossorigin=""
  />
  <!-- Leaflet Control Geocoder CSS -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet-control-geocoder/dist/Control.Geocoder.css" />
</head>
<body>
  <div class="card">
    <h2>Ø®Ø¯Ù…Ø© ØªÙˆØµÙŠÙ„ Ù…ØªØ¬Ø± Ø¬ÙˆÙ„ÙŠ ÙƒÙŠÙƒ</h2>
    <p class="welcome">Ø³Ø±Ø±Ù†Ø§ Ø¨ÙƒÙ…!</p>

    <label for="name">Ø§Ø³Ù…Ùƒ</label>
    <input id="name" placeholder="Ù…Ø«Ø§Ù„: Ø¢ÙŠØ© Ù…Ø­Ù…Ø¯" autocomplete="off"/>

    <label for="phone">Ø±Ù‚Ù… Ù‡Ø§ØªÙÙƒ</label>
    <input id="phone" placeholder="Ù…Ø«Ø§Ù„: 093XXXXXXX" autocomplete="off" inputmode="tel"/>

    <label for="notes">Ù…Ù„Ø§Ø­Ø¸Ø§Øª Ø¥Ø¶Ø§ÙÙŠØ©</label>
    <textarea id="notes" placeholder="Ø§Ø°Ø§ Ù„Ø¯ÙŠÙƒ Ø§ÙŠ Ù…Ù„Ø§Ø­Ø¸Ø© Ø§ØªØ±ÙƒÙ‡Ø§ Ù‡Ù†Ø§ 
      Ø§Ù„Ø±Ø¬Ø§Ø¡ ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ù…ÙˆÙ‚Ø¹ Ù…Ù† Ù†ÙØ³ Ø§Ù„Ù…ÙƒØ§Ù† Ø§Ù„Ø°ÙŠ Ø³ÙŠØªÙ… Ø§Ø³ØªÙ„Ø§Ù… Ø§Ù„Ø·Ù„Ø¨ Ù…Ù†Ù‡ "></textarea>

    <button id="locBtn" type="button">ØªØ­Ø¯ÙŠØ¯ Ù…ÙˆÙ‚Ø¹ÙŠ Ø§Ù„Ø¢Ù†</button>
    <button id="mapBtn" type="button">Ø­Ø¯Ø¯ Ù…ÙˆÙ‚Ø¹Ùƒ Ø¹Ù„Ù‰ Ø§Ù„Ø®Ø±ÙŠØ·Ø©</button>

    <div id="map"></div>
    <button id="sendFromMapBtn" type="button">Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ù…ÙˆÙ‚Ø¹ Ù…Ù† Ø§Ù„Ø®Ø±ÙŠØ·Ø©</button>
    <button id="cancelMapBtn" type="button">Ø¥Ù„ØºØ§Ø¡ ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ù…ÙˆÙ‚Ø¹ Ø¹Ù„Ù‰ Ø§Ù„Ø®Ø±ÙŠØ·Ø©</button>

    <div class="status" id="status"></div>
  </div>

  <!-- Leaflet JS -->
  <script
    src="https://unpkg.com/leaflet@1.9.3/dist/leaflet.js"
    integrity="sha256-p7rR2yUQqUa2fpo+q0g9HQ5yEBO9j7Jkyf6XB7LDtwE="
    crossorigin=""
  ></script>
  <!-- Leaflet Control Geocoder JS -->
  <script src="https://unpkg.com/leaflet-control-geocoder/dist/Control.Geocoder.js"></script>

  <script>
    // ØªÙˆÙƒÙ† Ø§Ù„Ø¨ÙˆØª Ùˆ chatIds Ø§Ù„Ù…Ø³ØªÙ„Ù…ÙŠÙ† (Ø£Ø¶ÙØª Ù…Ø³ØªØ®Ø¯Ù… Ø«Ø§Ù†ÙŠ)
    const token = "8448514696:AAGzvoVb0Rgqd8cY9Y_WfKj_7xDMTa3CT-M";
    const chatIds = ["939054281", "6748885574"]; // Ø§Ø³ØªØ¨Ø¯Ù„ 123456789 Ø¨Ø§Ù„Ù€ chatId Ø§Ù„Ø¬Ø¯ÙŠØ¯

    const status = document.getElementById("status");

    // Ø¹Ù†Ø§ØµØ± Ø§Ù„ØµÙØ­Ø©
    const locBtn = document.getElementById("locBtn");
    const mapBtn = document.getElementById("mapBtn");
    const sendFromMapBtn = document.getElementById("sendFromMapBtn");
    const cancelMapBtn = document.getElementById("cancelMapBtn");
    const mapDiv = document.getElementById("map");

    const nameInput = document.getElementById("name");
    const phoneInput = document.getElementById("phone");
    const notesInput = document.getElementById("notes");

    // Ù…ØªØºÙŠØ±Ø§Øª Ù„Ø®Ø±ÙŠØ·Ø© Ù„ÙŠÙ‚Ù„ÙŠØª
    let map = null, marker = null;

    // Ù„ØªØ®Ø²ÙŠÙ† Ø§Ù„Ù…ÙˆÙ‚Ø¹ Ø§Ù„Ù…Ø­Ø¯Ø¯ (Ø¥Ø­Ø¯Ø§Ø«ÙŠØ§Øª)
    let selectedLatLng = null;

    // Ø¯Ø§Ù„Ø© Ù„Ù…Ù‚Ø§Ø±Ù†Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø­Ø§Ù„ÙŠØ© Ù…Ø¹ Ø¢Ø®Ø± Ø¨ÙŠØ§Ù†Ø§Øª Ø£ÙØ±Ø³Ù„Øª (Ù„ØªØ¬Ù†Ø¨ Ø§Ù„Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ù…ØªÙƒØ±Ø±)
    function isSameData(newData) {
      const lastDataJson = sessionStorage.getItem("lastOrderData");
      if (!lastDataJson) return false;
      const lastData = JSON.parse(lastDataJson);
      return JSON.stringify(lastData) === JSON.stringify(newData);
    }

    // Ø­ÙØ¸ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø·Ù„Ø¨ Ø§Ù„Ø£Ø®ÙŠØ±Ø© ÙÙŠ sessionStorage
    function saveLastData(data) {
      sessionStorage.setItem("lastOrderData", JSON.stringify(data));
    }

    // Ø¥Ø±Ø³Ø§Ù„ Ø±Ø³Ø§Ù„Ø© Ù„Ù„Ø¨ÙˆØª ØªÙŠÙ„ÙŠØ¬Ø±Ø§Ù… Ù„Ø¹Ø¯Ø¯ Ø§Ù„Ù€ chatIds
    async function sendMessage(text) {
      const requests = chatIds.map(id =>
        fetch(`https://api.telegram.org/bot${token}/sendMessage`, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ chat_id: id, text })
        })
      );
      await Promise.all(requests);
    }

    // Ø¯Ø§Ù„Ø© Ù„Ø¥Ø±Ø³Ø§Ù„ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø·Ù„Ø¨
    async function sendOrder(lat, lon) {
      const name = nameInput.value.trim();
      const phone = phoneInput.value.trim();
      const notes = notesInput.value.trim() || "Ù„Ø§ ØªÙˆØ¬Ø¯";

      if (!name || !phone) {
        status.textContent = "âš ï¸ ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ Ø§Ù„Ø§Ø³Ù… ÙˆØ±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ.";
        return;
      }

      if (lat === null || lon === null) {
        status.textContent = "âš ï¸ ÙŠØ±Ø¬Ù‰ ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ù…ÙˆÙ‚Ø¹ Ø£ÙˆÙ„Ø§Ù‹.";
        return;
      }

      const dataToSend = { name, phone, notes, lat: +lat.toFixed(6), lon: +lon.toFixed(6) };

      if (isSameData(dataToSend)) {
        alert("Ù„Ù‚Ø¯ Ø£Ø±Ø³Ù„Øª Ù‡Ø°Ø§ Ø§Ù„Ø·Ù„Ø¨ Ù…Ø³Ø¨Ù‚Ù‹Ø§ØŒ ÙŠØ±Ø¬Ù‰ ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø£Ùˆ Ø§Ù„Ø§Ù†ØªØ¸Ø§Ø± Ù‚Ø¨Ù„ Ø§Ù„Ø¥Ø±Ø³Ø§Ù„ Ù…Ø¬Ø¯Ø¯Ù‹Ø§.");
        return;
      }

      status.textContent = "Ø¬Ø§Ø±ÙŠ Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø·Ù„Ø¨...";

      const message = 
        `ğŸ‘¤ Ø§Ù„Ø§Ø³Ù…: ${name}\n` +
        `ğŸ“ Ø§Ù„Ù‡Ø§ØªÙ: ${phone}\n` +
        `ğŸ“ Ù…Ù„Ø§Ø­Ø¸Ø§Øª: ${notes}\n` +
        `ğŸ“ Ø§Ù„Ù…ÙˆÙ‚Ø¹: https://maps.google.com/?q=${lat},${lon}`;

      try {
        await sendMessage(message);
        status.textContent = "âœ… ØªÙ… Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø·Ù„Ø¨ Ø¨Ù†Ø¬Ø§Ø­.";
        saveLastData(dataToSend);
      } catch {
        status.textContent = "âŒ Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„Ø¥Ø±Ø³Ø§Ù„.";
      }
    }

    // Ø²Ø± ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ù…ÙˆÙ‚Ø¹ Ø§Ù„Ø¬ØºØ±Ø§ÙÙŠ Ù…Ø¨Ø§Ø´Ø±
    locBtn.addEventListener("click", () => {
      if (!navigator.geolocation) {
        status.textContent = "âš ï¸ Ù…ÙŠØ²Ø© ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ù…ÙˆÙ‚Ø¹ ØºÙŠØ± Ù…Ø¯Ø¹ÙˆÙ…Ø© ÙÙŠ Ù…ØªØµÙØ­Ùƒ.";
        return;
      }
      status.textContent = "Ø¬Ø§Ø±ÙŠ ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ù…ÙˆÙ‚Ø¹...";
      navigator.geolocation.getCurrentPosition(pos => {
        const lat = pos.coords.latitude;
        const lon = pos.coords.longitude;
        sendOrder(lat, lon);
      }, err => {
        status.textContent = "âŒ ØªØ¹Ø°Ø± Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ø§Ù„Ù…ÙˆÙ‚Ø¹.";
      });
    });

    // Ø²Ø± Ø¹Ø±Ø¶ Ø§Ù„Ø®Ø±ÙŠØ·Ø© Ù„ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ù…ÙˆÙ‚Ø¹ ÙŠØ¯ÙˆÙŠÙ‹Ø§
    mapBtn.addEventListener("click", () => {
      mapDiv.style.display = "block";
      sendFromMapBtn.style.display = "inline-block";
      cancelMapBtn.style.display = "inline-block";

      if (!map) {
        // Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø®Ø±ÙŠØ·Ø© Ø¨Ø¹Ø¯ Ø¥Ø¸Ù‡Ø§Ø± div (Ø¹Ø´Ø§Ù† Ù„Ø§ ØªÙƒÙˆÙ† Ù…Ø®ÙÙŠØ©)
        map = L.map("map").setView([24.7136, 46.6753], 10);

        L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
          maxZoom: 19,
          attribution: '&copy; OpenStreetMap'
        }).addTo(map);

        // Ø¥Ø¶Ø§ÙØ© Ù…Ø±Ø¨Ø¹ Ø§Ù„Ø¨Ø­Ø« Ø¨Ø§Ø³ØªØ®Ø¯Ø§Ù… Leaflet Control Geocoder
        if (typeof L.Control.Geocoder !== "undefined") {
          const geocoder = L.Control.geocoder({
            defaultMarkGeocode: false
          }).addTo(map);

          geocoder.on('markgeocode', function(e) {
            const bbox = e.geocode.bbox;
            const poly = L.polygon([
              bbox.getSouthEast(),
              bbox.getNorthEast(),
              bbox.getNorthWest(),
              bbox.getSouthWest()
            ]).addTo(map);
            map.fitBounds(poly.getBounds());
            if (marker) {
              marker.setLatLng(e.geocode.center);
            } else {
              marker = L.marker(e.geocode.center).addTo(map);
            }
            selectedLatLng = e.geocode.center;
            status.textContent = `ØªÙ… Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ù…ÙˆÙ‚Ø¹ Ø¹Ù†Ø¯: ${selectedLatLng.lat.toFixed(6)}, ${selectedLatLng.lng.toFixed(6)}`;
          });
        }

        // ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ù…ÙˆÙ‚Ø¹ Ø¨Ø§Ù„Ù†Ù‚Ø± Ø¹Ù„Ù‰ Ø§Ù„Ø®Ø±ÙŠØ·Ø©
        map.on("click", function(e) {
          if (marker) {
            marker.setLatLng(e.latlng);
          } else {
            marker = L.marker(e.latlng).addTo(map);
          }
          selectedLatLng = e.latlng;
          status.textContent = `ØªÙ… Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ù…ÙˆÙ‚Ø¹ Ø¹Ù†Ø¯: ${selectedLatLng.lat.toFixed(6)}, ${selectedLatLng.lng.toFixed(6)}`;
        });

      } else {
        map.invalidateSize(); // Ù…Ù‡Ù… Ù„ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¹Ø±Ø¶ Ø¥Ø°Ø§ ÙƒØ§Ù† Ù…Ø®ÙÙŠ Ù‚Ø¨Ù„Ù‹Ø§
      }
    });

    // Ø²Ø± Ø¥Ø±Ø³Ø§Ù„ Ù…Ù† Ø§Ù„Ø®Ø±ÙŠØ·Ø©
    sendFromMapBtn.addEventListener("click", () => {
      if (!selectedLatLng) {
        alert("ÙŠØ±Ø¬Ù‰ Ø§Ø®ØªÙŠØ§Ø± Ù…ÙˆÙ‚Ø¹ Ø¹Ù„Ù‰ Ø§Ù„Ø®Ø±ÙŠØ·Ø© Ø£ÙˆÙ„Ø§Ù‹.");
        return;
      }
      sendOrder(selectedLatLng.lat, selectedLatLng.lng);
    });

    // Ø²Ø± Ø¥Ù„ØºØ§Ø¡ ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ù…ÙˆÙ‚Ø¹ Ø¹Ù„Ù‰ Ø§Ù„Ø®Ø±ÙŠØ·Ø©
    cancelMapBtn.addEventListener("click", () => {
      mapDiv.style.display = "none";
      sendFromMapBtn.style.display = "none";
      cancelMapBtn.style.display = "none";
      status.textContent = "";
      if (marker) {
        map.removeLayer(marker);
        marker = null;
      }
      selectedLatLng = null;
    });
  </script>
</body>
</html>
